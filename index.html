<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>–õ–æ–ª–∏ –ö–∞–∑–∏–∫</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;min-height:100%;background:#0a0a0f;color:#e8e8f0;font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif;overflow-x:hidden;-webkit-font-smoothing:antialiased}
.wrap{display:flex;flex-direction:column;align-items:center;padding:14px 14px 32px;max-width:420px;margin:0 auto;gap:10px}
h1{font-size:22px;font-weight:900;text-align:center;line-height:1.2;letter-spacing:-.5px;background:linear-gradient(135deg,#FFD700,#FFA500,#FF2F7B);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.sub{font-size:10px;color:#555577;letter-spacing:.5px;text-align:center}
/* –í–∫–ª–∞–¥–∫–∏ */
.tabs{width:100%;display:flex;background:#12121a;border-radius:12px;padding:3px;gap:2px}
.tab{flex:1;padding:8px;text-align:center;font-size:12px;font-weight:700;border-radius:10px;cursor:pointer;color:#555577;transition:all .2s;border:none;background:none}
.tab.active{background:linear-gradient(135deg,#7B2FFF,#FF2F7B);color:#fff}
.page{width:100%;display:none;flex-direction:column;align-items:center;gap:10px}
.page.active{display:flex}
/* –ö–æ–ª–µ—Å–æ */
.wheel-wrap{position:relative;width:min(270px,82vw);height:min(270px,82vw);flex-shrink:0}
#wcanvas{width:100%;height:100%;border-radius:50%;display:block;-webkit-transform:translateZ(0);transform:translateZ(0)}
.arrow{position:absolute;top:-12px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:20px solid #FFD700;filter:drop-shadow(0 0 5px rgba(255,215,0,.9));z-index:5}
.spin-btn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:58px;height:58px;border-radius:50%;background:linear-gradient(135deg,#7B2FFF,#FF2F7B);border:3px solid rgba(255,255,255,.25);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;cursor:pointer;z-index:10;box-shadow:0 0 16px rgba(123,47,255,.7);-webkit-appearance:none;transition:transform .1s,opacity .2s;user-select:none;-webkit-user-select:none}
.spin-btn:active{transform:translate(-50%,-50%) scale(.9)}
.spin-btn:disabled{opacity:.4;cursor:default}
.spin-btn .ico{font-size:18px;line-height:1}
.spin-btn .lbl{font-size:7px;font-weight:700;color:#fff;letter-spacing:.5px}
.cd{font-size:11px;color:#555577;text-align:center;min-height:15px;font-weight:600}
.cd.on{color:#FFD700}
.cd.limit{color:#FF2F7B}
.res{width:100%;background:#12121a;border:1px solid rgba(123,47,255,.35);border-radius:13px;padding:11px 14px;min-height:56px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px}
.res .lbl{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:#555577}
.res .txt{font-size:14px;font-weight:600;text-align:center;line-height:1.4}
.res .txt.win{color:#FFD700;font-weight:800}
.info-row{width:100%;display:flex;gap:8px}
.score-box{flex:1;background:rgba(123,47,255,.12);border:1px solid rgba(123,47,255,.3);border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;gap:5px}
.score-box .lbl{font-size:9px;color:#555577;text-transform:uppercase;letter-spacing:1px}
.score-box .val{font-size:20px;font-weight:900;color:#FFD700}
.score-box .rval{font-size:13px;font-weight:700}
.player-box{background:#12121a;border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;justify-content:space-between;min-width:110px}
.player-box .pname{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100px;margin-top:3px}
.player-box .change{font-size:10px;color:#7B2FFF;cursor:pointer;text-decoration:underline;margin-top:6px}
/* –¢–æ–ø */
.top-list{width:100%;display:flex;flex-direction:column;gap:5px}
.ti{display:flex;align-items:center;gap:9px;background:#12121a;border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:8px 12px}
.ti.me{border-color:rgba(123,47,255,.5);background:rgba(123,47,255,.1)}
.ti .rk{font-size:12px;font-weight:800;width:24px;text-align:center;flex-shrink:0}
.ti .nm{flex:1;font-size:12px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ti .sc{font-size:11px;font-weight:800;color:#FFD700;flex-shrink:0}
.empty{text-align:center;color:#555577;font-size:12px;padding:16px}
/* –ú–∞–≥–∞–∑–∏–Ω */
.shop-grid{width:100%;display:flex;flex-direction:column;gap:8px}
.shop-item{background:#12121a;border:1px solid rgba(123,47,255,.25);border-radius:14px;padding:13px 14px;display:flex;align-items:center;gap:12px}
.shop-item .ico{font-size:28px;flex-shrink:0}
.shop-item .info{flex:1}
.shop-item .name{font-size:14px;font-weight:700;margin-bottom:2px}
.shop-item .desc{font-size:11px;color:#666688}
.shop-item .price{font-size:13px;font-weight:800;color:#FFD700;margin-bottom:6px}
.buy-btn{background:linear-gradient(135deg,#7B2FFF,#FF2F7B);border:none;border-radius:10px;padding:7px 14px;font-size:12px;font-weight:700;color:#fff;cursor:pointer;-webkit-appearance:none;transition:transform .1s,opacity .2s;white-space:nowrap}
.buy-btn:active{transform:scale(.93)}
.buy-btn:disabled{opacity:.4;cursor:default}
.shop-note{font-size:11px;color:#555577;text-align:center;padding:4px 0}
/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.show{display:flex}
.modal{background:#1a1a28;border:1px solid rgba(123,47,255,.4);border-radius:20px;padding:24px 20px;width:100%;max-width:320px;text-align:center}
.modal h3{font-size:18px;font-weight:800;margin-bottom:8px}
.modal p{font-size:13px;color:#888;margin-bottom:20px;line-height:1.5}
.modal-btns{display:flex;gap:10px}
.modal-btns button{flex:1;padding:12px;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;-webkit-appearance:none}
.modal-cancel{background:#1e1e30;color:#888}
.modal-confirm{background:linear-gradient(135deg,#7B2FFF,#FF2F7B);color:#fff}
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#1a1a28;border:1px solid rgba(123,47,255,.4);border-radius:12px;padding:12px 20px;font-size:13px;font-weight:600;z-index:300;opacity:0;transition:opacity .3s;white-space:nowrap}
.toast.show{opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <h1>üé∞ –õ–û–õ–ò –ö–ê–ó–ò–ö</h1>
  <div class="sub">–∫—Ä—É—Ç–∏ ‚Äî –ø–æ–±–µ–∂–¥–∞–π ‚Äî —Å–æ—Ä–µ–≤–Ω—É–π—Å—è</div>

  <!-- –í–∫–ª–∞–¥–∫–∏ -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('spin')">üé∞ –ö—Ä—É—Ç–∏—Ç—å</button>
    <button class="tab" onclick="switchTab('shop')">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
    <button class="tab" onclick="switchTab('top')">üèÜ –¢–æ–ø</button>
  </div>

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞: –ö—Ä—É—Ç–∏—Ç—å -->
  <div class="page active" id="page-spin">
    <div class="wheel-wrap">
      <div class="arrow"></div>
      <canvas id="wcanvas"></canvas>
      <button class="spin-btn" id="spinBtn" onclick="doSpin()">
        <span class="ico">üéØ</span><span class="lbl">–ö–†–£–¢–ò</span>
      </button>
    </div>
    <div class="cd" id="cd"></div>
    <div id="bonusBar" style="display:none;width:100%;display:flex;gap:6px;flex-wrap:wrap;justify-content:center"></div>
    <div class="res">
      <div class="lbl">—á—Ç–æ –ø–æ–ª—É—á–∏–ª</div>
      <div class="txt" id="resText">–ù–∞–∂–º–∏ –ö–†–£–¢–ò!</div>
    </div>
    <div class="info-row">
      <div class="score-box">
        <div><div class="lbl">–æ—á–∫–∏</div><div class="val" id="myScore">0</div></div>
        <div><div class="lbl">–∫—Ä—É—á–µ–Ω–∏–π</div><div class="rval" id="mySpins">0</div></div>
      </div>
      <div class="player-box">
        <div><div class="lbl" style="font-size:9px;color:#555577;text-transform:uppercase;letter-spacing:1px">–∏–≥—Ä–æ–∫</div>
        <div class="pname" id="playerName">‚Äî</div></div>
        <div class="change" onclick="changeName()">—Å–º–µ–Ω–∏—Ç—å –∏–º—è</div>
      </div>
    </div>
  </div>

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞: –ú–∞–≥–∞–∑–∏–Ω -->
  <div class="page" id="page-shop">
    <div class="shop-note">–¢—Ä–∞—Ç—å –æ—á–∫–∏ –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫—Ä—É—Ç–∫–∏!</div>
    <div class="shop-grid" id="shopGrid"></div>
  </div>

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞: –¢–æ–ø -->
  <div class="page" id="page-top">
    <div class="top-list" id="topList"><div class="empty">–ë—É–¥—å –ø–µ—Ä–≤—ã–º!</div></div>
  </div>
</div>

<script>
const TG = window.Telegram?.WebApp;
if(TG){TG.ready();TG.expand()}
const TG_UID  = TG?.initDataUnsafe?.user?.id  ? String(TG.initDataUnsafe.user.id)  : '';
const TG_NAME = TG?.initDataUnsafe?.user?.first_name || '';

let UID='', UNAME='';

// ‚îÄ‚îÄ –í–∫–ª–∞–¥–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(name){
  document.querySelectorAll('.tab').forEach((t,i)=>{
    const names=['spin','shop','top'];
    t.classList.toggle('active', names[i]===name);
  });
  document.querySelectorAll('.page').forEach(p=>{
    p.classList.toggle('active', p.id==='page-'+name);
  });
  if(name==='top') renderLB();
  if(name==='shop') renderShop();
}

// ‚îÄ‚îÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function lsGet(k){try{return localStorage.getItem(k)||''}catch{return''}}
function lsSet(k,v){try{localStorage.setItem(k,v)}catch{}}

function initUser(){
  UID = TG_UID || lsGet('kz_uid') || 'u_'+Math.random().toString(36).slice(2,10);
  if(!TG_UID) lsSet('kz_uid', UID);

  // –ò–º—è: TG ‚Üí —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ ‚Üí –∞–≤—Ç–æ
  UNAME = TG_NAME || lsGet('kz_name_'+UID) || ('–ò–≥—Ä–æ–∫_'+UID.toString().slice(-4));
  lsSet('kz_name_'+UID, UNAME);

  document.getElementById('playerName').textContent = UNAME;
  setTimeout(resize, 50);
  loadMe();
  renderLB();
  renderShop();
}

function changeName(){
  const n = prompt('–ù–æ–≤–æ–µ –∏–º—è:', UNAME);
  if(!n||!n.trim()) return;
  UNAME = n.trim().slice(0,20);
  lsSet('kz_name_'+UID, UNAME);
  document.getElementById('playerName').textContent = UNAME;
  const lb=getLB(); if(lb[UID]){lb[UID].name=UNAME;setLB(lb);renderLB();}
}

// ‚îÄ‚îÄ –°–µ–≥–º–µ–Ω—Ç—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SEG=[
  {t:'–î–ñ–ï–ö–ü–û–¢',e:'üíé',p:1000,c:'#5515C5',w:0.5},
  {t:'–£–º—Ä–∏', e:'‚öî', p:200, c:'#B5154F',w:2},
  {t:'–ú–∏–Ω–µ—Ç–∫–∞',  e:'ü™ô',p:150, c:'#B87500',w:2},
  {t:'–ù–∏—á–µ–≥–æ',  e:'üíÄ',p:0,   c:'#151525',w:1.5},
  {t:'–ö–∏—Å–ª–æ—Ç–∞',   e:'üß™',p:100, c:'#0E9050',w:2.5},
  {t:' –¢–¢ –æ–≥–æ–Ω–µ–∫',   e:'üî•',p:50,  c:'#B03808',w:3},
  {t:'–ù–∏—á–µ–≥–æ',  e:'üíÄ',p:0,   c:'#151525',w:1.5},
  {t:'–î–µ—Ä—å–º–æ',     e:'üõ°', p:120, c:'#0E48B0',w:2.5},
  {t:'–ú–∞—Ç–∏–ª—å–¥–∞',  e:'‚≠ê',p:300, c:'#B08000',w:1.5},
  {t:'–ù–∏—á–µ–≥–æ',  e:'üíÄ',p:0,   c:'#151525',w:1.5},
  {t:'–û–ø–ª–æ—à–Ω–æ—Å—Ç—å',     e:'üó°', p:80,  c:'#981038',w:2.5},
  {t:'–ß—É–¥–æ',   e:'ü™Ñ',p:250, c:'#780EB8',w:1.5},
];
const N=SEG.length, ARC=2*Math.PI/N, COOL=5000, DAILY_LIMIT=10;

// ‚îÄ‚îÄ –ú–∞–≥–∞–∑–∏–Ω ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SHOP = [
  // –ö—Ä—É—Ç–∫–∏
  {id:'s1', name:'+3 –∫—Ä—É—Ç–∫–∏',    desc:'–ù–µ–±–æ–ª—å—à–∞—è –¥–æ–±–∞–≤–∫–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è',   price:600,  spins:3,  ico:'üé∞', type:'spins'},
  {id:'s2', name:'+10 –∫—Ä—É—Ç–æ–∫',   desc:'–•–æ—Ä–æ—à–∏–π –∑–∞–ø–∞—Å –Ω–∞ –≤–µ—á–µ—Ä',         price:1000,  spins:10, ico:'üé™', type:'spins'},
  {id:'s3', name:'+30 –∫—Ä—É—Ç–æ–∫',   desc:'–ö—Ä—É—Ç–∏ –≤–µ—Å—å –¥–µ–Ω—å –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏',  price:2400, spins:30, ico:'üé°', type:'spins'},
  {id:'s4', name:'+100 –∫—Ä—É—Ç–æ–∫',  desc:'–ë–µ–∑–ª–∏–º–∏—Ç –Ω–∞ —Ü–µ–ª—ã–π –¥–µ–Ω—å',         price:7000, spins:100,ico:'üëë', type:'spins'},
  // –£–¥–∞—á–∞
  {id:'s5', name:'üçÄ –£–¥–∞—á–∞ x2',  desc:'–°–ª–µ–¥—É—é—â–∏–µ 3 –∫—Ä—É—á–µ–Ω–∏—è ‚Äî –¥–≤–æ–π–Ω—ã–µ –æ—á–∫–∏', price:500, luck:3, ico:'üçÄ', type:'luck'},
  {id:'s6', name:'üõ°Ô∏è –ó–∞—â–∏—Ç–∞',    desc:'–°–ª–µ–¥—É—é—â–∏–π "–ù–∏—á–µ–≥–æ" –¥–∞—Å—Ç 100 –æ—á–∫–æ–≤',   price:2
150, shield:1,ico:'üõ°Ô∏è', type:'shield'},
  {id:'s7', name:'‚ö° –°—É–ø–µ—Ä—É–¥–∞—á–∞', desc:'–°–ª–µ–¥—É—é—â–µ–µ –∫—Ä—É—á–µ–Ω–∏–µ ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏–∑ (–Ω–µ –ù–∏—á–µ–≥–æ)', price:800, superSpin:1, ico:'‚ö°', type:'super'},
];

function renderShop(){
  const grid = document.getElementById('shopGrid');
  const spins = SHOP.filter(s=>s.type==='spins');
  const bonus = SHOP.filter(s=>s.type!=='spins');
  function itemHtml(item){
    return `<div class="shop-item">
      <div class="ico">${item.ico}</div>
      <div class="info">
        <div class="name">${item.name}</div>
        <div class="desc">${item.desc}</div>
        <div class="price">üí∞ ${item.price} –æ—á–∫–æ–≤</div>
      </div>
      <button class="buy-btn" id="buy_${item.id}" onclick="buyItem('${item.id}')">–ö—É–ø–∏—Ç—å</button>
    </div>`;
  }
  grid.innerHTML =
    '<div style="font-size:11px;font-weight:700;color:#7B2FFF;letter-spacing:1px;align-self:flex-start">üé∞ –ö–†–£–¢–ö–ò</div>' +
    spins.map(itemHtml).join('') +
    '<div style="font-size:11px;font-weight:700;color:#FF2F7B;letter-spacing:1px;align-self:flex-start;margin-top:4px">‚ú® –ë–û–ù–£–°–´</div>' +
    bonus.map(itemHtml).join('');
  updateShopBtns();
}

function updateShopBtns(){
  SHOP.forEach(item=>{
    const btn = document.getElementById('buy_'+item.id);
    if(btn) btn.disabled = me.score < item.price;
  });
}

function showToast(msg, ms=2500){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), ms);
}

function showModal(title, text, onConfirm){
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalText').textContent = text;
  document.getElementById('modalOverlay').classList.add('show');
  document.getElementById('modalConfirm').onclick = ()=>{
    closeModal();
    onConfirm();
  };
}

function closeModal(){
  document.getElementById('modalOverlay').classList.remove('show');
}

function buyItem(id){
  const item = SHOP.find(s=>s.id===id);
  if(!item) return;
  if(me.score < item.price){
    showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤!');
    return;
  }
  showModal(
    item.ico + ' ' + item.name,
    `–ü–æ—Ç—Ä–∞—Ç–∏—Ç—å ${item.price} –æ—á–∫–æ–≤?\n–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${me.score} –æ—á–∫–æ–≤.`,
    ()=>{
      me.score -= item.price;
      if(item.type==='spins'){
        me.bonusSpins = (me.bonusSpins||0) + item.spins;
        showToast('‚úÖ +' + item.spins + ' –∫—Ä—É—Ç–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–æ!');
      } else if(item.type==='luck'){
        me.luckSpins = (me.luckSpins||0) + item.luck;
        showToast('‚úÖ üçÄ –£–¥–∞—á–∞ x2 –Ω–∞ ' + item.luck + ' –∫—Ä—É—á–µ–Ω–∏—è!');
      } else if(item.type==='shield'){
        me.shield = (me.shield||0) + 1;
        showToast('‚úÖ üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!');
      } else if(item.type==='super'){
        me.superSpin = (me.superSpin||0) + 1;
        showToast('‚úÖ ‚ö° –°—É–ø–µ—Ä—É–¥–∞—á–∞ –≥–æ—Ç–æ–≤–∞!');
      }
      saveMe();
      updUI();
      updateShopBtns();
      updCD();
      TG?.HapticFeedback?.notificationOccurred?.('success');
    }
  );
}

// ‚îÄ‚îÄ Canvas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const cv=document.getElementById('wcanvas');
const ctx=cv.getContext('2d');
let sz=270;

function resize(){
  const el=cv.parentElement;
  if(!el||el.offsetWidth===0){setTimeout(resize,100);return}
  sz=el.offsetWidth;
  const dpr=Math.min(window.devicePixelRatio||1,2);
  cv.width=sz*dpr; cv.height=sz*dpr;
  ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
  draw(rot);
}

function lighten(hex,a){
  const n=parseInt(hex.slice(1),16);
  return `rgb(${Math.min(255,(n>>16)+a)},${Math.min(255,((n>>8)&0xff)+a)},${Math.min(255,(n&0xff)+a)})`;
}

function draw(angle){
  const cx=sz/2,cy=sz/2,R=sz/2-5;
  ctx.clearRect(0,0,sz,sz);
  for(let i=0;i<N;i++){
    const s=SEG[i],a0=angle+i*ARC,a1=a0+ARC;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,R,a0,a1);ctx.closePath();
    const gr=ctx.createRadialGradient(cx,cy,R*.15,cx,cy,R);
    gr.addColorStop(0,lighten(s.c,60));gr.addColorStop(1,s.c);
    ctx.fillStyle=gr;ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.45)';ctx.lineWidth=1.5;ctx.stroke();
    const mid=angle+i*ARC+ARC/2;
    const norm=((mid%(2*Math.PI))+2*Math.PI)%(2*Math.PI);
    const flip=norm>Math.PI*.5&&norm<Math.PI*1.5;
    ctx.save();ctx.translate(cx,cy);ctx.rotate(flip?mid+Math.PI:mid);
    const d=flip?-1:1;
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.shadowColor='rgba(0,0,0,.95)';ctx.shadowBlur=5;
    ctx.fillStyle='#fff';
    ctx.font=`bold ${sz<240?9:10}px -apple-system,Arial,sans-serif`;
    ctx.fillText(s.t,d*R*.68,-5);
    if(s.p>0){ctx.fillStyle='#FFE000';ctx.font=`bold ${sz<240?8:9}px -apple-system,Arial,sans-serif`;ctx.fillText('+'+s.p,d*R*.68,7)}
    ctx.shadowBlur=0;ctx.font=`${sz<240?11:13}px -apple-system,Arial,sans-serif`;ctx.fillStyle='#fff';
    ctx.fillText(s.e,d*R*.44,1);
    ctx.restore();
  }
  ctx.beginPath();ctx.arc(cx,cy,R+2,0,2*Math.PI);
  const bg=ctx.createLinearGradient(0,0,sz,sz);
  bg.addColorStop(0,'#7B2FFF');bg.addColorStop(.5,'#FFD700');bg.addColorStop(1,'#FF2F7B');
  ctx.strokeStyle=bg;ctx.lineWidth=4;ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,32,0,2*Math.PI);
  ctx.fillStyle='#0a0a0f';ctx.fill();
  ctx.strokeStyle='rgba(123,47,255,.6)';ctx.lineWidth=2;ctx.stroke();
}

// ‚îÄ‚îÄ –î–∞–Ω–Ω—ã–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let me={score:0,spins:0,lastSpin:0,lastPrize:'',todaySpins:0,lastDay:'',bonusSpins:0};

function loadMe(){
  try{const d=JSON.parse(lsGet('kzme_'+UID));if(d)me={...me,...d}}catch{}
  updUI(); updCD();
  if(!canSpin()){const iv=setInterval(()=>{updCD();if(canSpin())clearInterval(iv)},500)}
}
function saveMe(){lsSet('kzme_'+UID,JSON.stringify(me))}
function updUI(){
  document.getElementById('myScore').textContent=me.score.toLocaleString();
  document.getElementById('mySpins').textContent=me.spins;
  // –ë–æ–Ω—É—Å –±–∞—Ä
  const bar=document.getElementById('bonusBar');
  const badges=[];
  if(me.luckSpins>0) badges.push(`üçÄx${me.luckSpins}`);
  if(me.shield>0) badges.push(`üõ°Ô∏èx${me.shield}`);
  if(me.superSpin>0) badges.push(`‚ö°x${me.superSpin}`);
  if(badges.length){
    bar.style.display='flex';
    bar.innerHTML=badges.map(b=>`<span style="background:rgba(123,47,255,.2);border:1px solid rgba(123,47,255,.4);border-radius:8px;padding:3px 8px;font-size:11px;font-weight:700">${b}</span>`).join('');
  } else {
    bar.style.display='none';
  }
}

// ‚îÄ‚îÄ –õ–∏–¥–µ—Ä–±–æ—Ä–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getLB(){try{return JSON.parse(lsGet('kzlb6'))||{}}catch{return{}}}
function setLB(lb){lsSet('kzlb6',JSON.stringify(lb))}
function renderLB(){
  const lb=getLB();
  const sorted=Object.entries(lb).map(([id,d])=>({id,...d})).sort((a,b)=>b.score-a.score).slice(0,10);
  const el=document.getElementById('topList');
  if(!sorted.length){el.innerHTML='<div class="empty">–ë—É–¥—å –ø–µ—Ä–≤—ã–º!</div>';return}
  const em=['ü•á','ü•à','ü•â'];
  el.innerHTML=sorted.map((p,i)=>`
    <div class="ti${p.id===UID?' me':''}">
      <div class="rk">${em[i]||i+1}</div>
      <div class="nm">${esc(p.name)}${p.id===UID?' üëà':''}</div>
      <div class="sc">${p.score.toLocaleString()}</div>
    </div>`).join('');
}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

// ‚îÄ‚îÄ –ö—É–ª–¥–∞—É–Ω –∏ –ª–∏–º–∏—Ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function todayStr(){return new Date().toDateString()}
function getTodaySpins(){
  if(me.lastDay!==todayStr()) return 0;
  return me.todaySpins||0;
}
function availableSpins(){
  return DAILY_LIMIT + (me.bonusSpins||0) - getTodaySpins();
}
function canSpin(){
  return Date.now()-me.lastSpin>=COOL && availableSpins()>0;
}
function updCD(){
  const el=document.getElementById('cd'),btn=document.getElementById('spinBtn');
  const avail=availableSpins();
  if(avail<=0){
    el.textContent=`üö´ –ö—Ä—É—Ç–æ–∫ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç. –ö—É–ø–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ!`;
    el.className='cd limit';btn.disabled=true;return;
  }
  if(Date.now()-me.lastSpin<COOL){
    const l=Math.ceil((COOL-(Date.now()-me.lastSpin))/1000);
    el.textContent=`‚è≥ –ø–æ–¥–æ–∂–¥–∏ ${l}—Å ‚Ä¢ –æ—Å—Ç–∞–ª–æ—Å—å ${avail} –∫—Ä—É—Ç–æ–∫`;
    el.className='cd on';btn.disabled=true;return;
  }
  el.textContent=`–û—Å—Ç–∞–ª–æ—Å—å –∫—Ä—É—Ç–æ–∫ —Å–µ–≥–æ–¥–Ω—è: ${avail}`;
  el.className='cd';btn.disabled=false;
}

// ‚îÄ‚îÄ –°–ø–∏–Ω ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let rot=0,spinning=false;
function doSpin(){
  if(spinning||!canSpin())return;
  spinning=true;
  document.getElementById('spinBtn').disabled=true;
  document.getElementById('resText').textContent='üé≤ –ö—Ä—É—Ç–∏—Ç—Å—è...';
  document.getElementById('resText').className='txt';
  const tot=SEG.reduce((a,s)=>a+s.w,0);
  let r=Math.random()*tot,winner=0;
  for(let i=0;i<N;i++){r-=SEG[i].w;if(r<=0){winner=i;break}}
  const extra=(6+Math.floor(Math.random()*4))*2*Math.PI;
  const diff=((-Math.PI/2-(winner*ARC+ARC/2)-rot)%(2*Math.PI)+2*Math.PI)%(2*Math.PI);
  const target=rot+extra+diff;
  const dur=5500+Math.random()*1500,t0=performance.now(),r0=rot;
  function ease(t){if(t<.15)return t*t*4.4;if(t<.65)return .1+(t-.15)*(0.8/.5);return .9+.1*(1-Math.pow((1-t)/.35,2.5))}
  function frame(now){
    const t=Math.min((now-t0)/dur,1);rot=r0+(target-r0)*ease(t);draw(rot);
    if(t<1)requestAnimationFrame(frame);else{rot=rot%(2*Math.PI);draw(rot);finish(winner)}
  }
  requestAnimationFrame(frame);
}

function finish(winner){
  spinning=false;
  const s=SEG[winner];
  // –ü—Ä–∏–º–µ–Ω—è–µ–º –±–æ–Ω—É—Å—ã
  let pts = s.p;
  // –°—É–ø–µ—Ä—Å–ø–∏–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ù–∏—á–µ–≥–æ
  if(me.superSpin>0 && s.p===0){
    me.superSpin--;
    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –Ω–µ-–Ω—É–ª–µ–≤–æ–π –ø—Ä–∏–∑
    const nonZero = SEG.filter(x=>x.p>0);
    const reSeg = nonZero[Math.floor(Math.random()*nonZero.length)];
    pts = reSeg.p;
    document.getElementById('resText').innerHTML = `‚ö° –°–£–ü–ï–†–£–î–ê–ß–ê! ${reSeg.e} <strong>${reSeg.t}</strong> +${pts}`;
    document.getElementById('resText').className='txt win';
  }
  // –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω—É–ª—è
  if(pts===0 && me.shield>0){pts=30;me.shield--;}
  // –£–¥–∞—á–∞ x2
  if(me.luckSpins>0){pts*=2;me.luckSpins--;}
  me.score+=pts; me.spins++;
  me.lastSpin=Date.now(); me.lastPrize=s.e+' '+s.t;
  // –î–Ω–µ–≤–Ω–æ–π —Å—á—ë—Ç—á–∏–∫
  if(me.lastDay!==todayStr()){me.todaySpins=1;me.lastDay=todayStr();me.bonusSpins=0;}
  else me.todaySpins=(me.todaySpins||0)+1;
  saveMe();
  // –õ–∏–¥–µ—Ä–±–æ—Ä–¥
  const lb=getLB();
  lb[UID]={name:UNAME,score:me.score,spins:me.spins};
  setLB(lb);
  const rt=document.getElementById('resText');
  if(s.p>0){
    rt.innerHTML=`${s.e} <strong>${s.t}</strong> +${s.p} –æ—á–∫–æ–≤`;
    rt.className='txt win';
    TG?.HapticFeedback?.impactOccurred?.('heavy');
  }else{
    rt.textContent='üíÄ –ù–∏—á–µ–≥–æ... –µ—â—ë —Ä–∞–∑!';
    rt.className='txt';
    TG?.HapticFeedback?.notificationOccurred?.('error');
  }
  updUI(); renderLB(); updateShopBtns();
  const iv=setInterval(()=>{updCD();if(canSpin())clearInterval(iv)},500);
  updCD();
}

window.addEventListener('resize',resize);
initUser();
</script>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫—É–ø–∫–∏ -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h3 id="modalTitle"></h3>
    <p id="modalText"></p>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-confirm" id="modalConfirm">–ö—É–ø–∏—Ç—å</button>
    </div>
  </div>
</div>
<!-- –¢–æ—Å—Ç -->
<div class="toast" id="toast"></div>
</body>
</html>
